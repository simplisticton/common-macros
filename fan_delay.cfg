[delayed_gcode _DISABLE_FAN_DELAY]
initial_duration: 0
gcode:
  DISABLE_FAN

[gcode_macro FAN_DELAY]
gcode:
  {% set fan = params.FAN|string %}
  {% set delay = params.DELAY|default(300)|float %}
  {% set power = params.POWER|default(100)|float %}

  SET_GCODE_VARIABLE MACRO=DISABLE_FAN VARIABLE=fan VALUE='"{fan}"'

  M118 Setting {fan} to {power} for {delay}s
  SET_FAN_SPEED FAN={fan} SPEED={power}
  UPDATE_DELAYED_GCODE ID=_DISABLE_FAN_DELAY DURATION={delay}

[gcode_macro DISABLE_FAN]
variable_fan: ''
gcode:

  SET_FAN_SPEED FAN={fan} SPEED=0
